<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/602326 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="7416"/>

<div>
<span><div><div><div><div>20201114 第10课</div><hr/><div><br/></div><div>1.从Spring到Spring Boot</div></div><div>Spring变得越来越复杂</div><div>Spring臃肿以后的必然选择，一切都是为了简化</div><div>    让<span style="font-weight: bold;">开发、配置、运行</span>变简单</div><div><br/></div><div>变简单方式：整合，SSH、SSM、国产的SpringSide（唯品会的江南白衣）</div><div><br/></div><div>限定性框架 - SpringBoot</div><div>    增加前提</div><div>    把之前踩过的坑，变为最佳实践</div><div>非限定性框架 - Spring</div><div>    通用，但都不是极致</div><div> </div><div>编码规范：避免潜在的问题，避免风格的不同</div><div><br/></div><div><span style="font-weight: bold;">约定大于配置</span></div><div><br/></div><div>Spring Boot是Spring的一套快速配置脚手架，关注于<span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">自动配置，配置驱动</span>。</div><div><br/></div><ul><li><div>Java开发Web应用的事实标准，技术成熟与完善</div></li><li><div>去web容器化，tomcat内置（tomcat/jetty）</div></li><li><div>基于Maven与pom的Java生态体系，整合pom模板成为可能</div></li><li><div>避免大量maven导入和各种版本冲突</div></li></ul><div><br/></div><div>框架：与业务无关工具的整合</div><div>脚手架：整合好的各种框架</div><div>解决方案：针对某个领域的解决办法</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>Spring Boot makes it easy to create stand-alone, production-grade Spring based Applications that you can &quot;just run&quot;.</div><div>We take an opinionated view of the Spring platform and third-party libraries so you can get started with minimum fuss. Most Spring Boot applications need minimal Spring configuration.</div><div><br/></div><div>Features</div><div>* Create stand-alone Spring applications</div><div>* Embed Tomcat, Jetty or Undertow directly (no need to deploy WAR files)</div><div>* Provide opinionated 'starter' dependencies to simplify your build configuration</div><div>* Automatically configure Spring and 3rd party libraries whenever possible</div><div>* Provide production-ready features such as metrics, health checks, and externalized configuration</div><div>* Absolutely no code generation and no requirement for XML configuration</div></div><div>特性：</div><ul><li><div>创建独立运行的Spring应用</div></li><li><div>直接嵌入tomcathuojetty，undertow，无需部署war包</div></li><li><div>提供限定性的starter依赖简化配置</div></li><li><div>在必要时自动配置Spring和其他三方依赖库</div></li><li><div>提供生产production-ready特性，例如指标度量，健康检查，外部配置等</div></li><li><div>完全零代码生产和不需要xml配置</div></li></ul><div><br/></div><div>使用Maven可以打fat-jar，或shade插件</div><div>Spring全线使用Gradle打包</div><div><br/></div><hr/><div><br/></div><div><span style="font-weight: bold;">2.Spring Boot核心原理*</span></div><div><br/></div><div>2.1自动化配置：简化配置中心</div><div>基于Configuration，EnableXXX，Condition</div><div><br/></div><div>2.2spring-boot-starter：脚手架核心</div><div>整合各种第三方类库，协同工具</div><div><br/></div><div>官网生成空项目的pom文件</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div>&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</div><div>    xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</div><div>    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</div><div>    &lt;parent&gt;</div><div>        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div>        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</div><div>        &lt;version&gt;2.4.0&lt;/version&gt;</div><div>        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;</div><div>    &lt;/parent&gt;</div><div>    &lt;groupId&gt;com.transformers&lt;/groupId&gt;</div><div>    &lt;artifactId&gt;springboot-empty&lt;/artifactId&gt;</div><div>    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</div><div>    &lt;name&gt;springboot-empty&lt;/name&gt;</div><div>    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;</div><div><br/></div><div>    &lt;properties&gt;</div><div>        &lt;java.version&gt;1.8&lt;/java.version&gt;</div><div>    &lt;/properties&gt;</div><div><br/></div><div>    &lt;dependencies&gt;</div><div>        &lt;dependency&gt;</div><div>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div>            &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;</div><div>        &lt;/dependency&gt;</div><div><br/></div><div>        &lt;dependency&gt;</div><div>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div>            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</div><div>            &lt;scope&gt;test&lt;/scope&gt;</div><div>        &lt;/dependency&gt;</div><div>    &lt;/dependencies&gt;</div><div><br/></div><div>    &lt;build&gt;</div><div>        &lt;plugins&gt;</div><div>            &lt;plugin&gt;</div><div>                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div>                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</div><div>            &lt;/plugin&gt;</div><div>        &lt;/plugins&gt;</div><div>    &lt;/build&gt;</div><div><br/></div><div>&lt;/project&gt;</div></div><div>约定大于配置（Convention Over Configuration）也称作按约定编程是一种软件设计范式。</div><div>约定大于配置，优势：</div><ul><li><div>Maven目录结构：默认有resources文件夹存放配置文件，默认打包方式为jar</div></li><li><div>默认配置文件：application.properties或application.yml文件</div></li><li><div>默认spring.profiles.active属性来决定运行环境时的配置文件</div></li><li><div>EnableAutoConfiguration默认对于依赖的starter进行自动装配</div></li><li><div>spring-boot-starter-web中默认包含spring-mvc相关依赖以及内置的web容器，使得构建一个web应用更加简单</div></li></ul><div><br/></div><div>2. （选做）maven/spring的profile机制，都有什么用法？</div><hr/><div>对于SpringBoot</div><div><span style="font-weight: bold;">多环境配置</span></div><div><span style="font-weight: bold;">properties配置文件</span></div><div>使用properties配置文件实现多环境配置，只能通过添加多个application-{profile}.properties来实现。</div><div>比如：application-dev.properties,application-test.properties</div><div><span style="font-weight: bold;">YAML配置文件</span></div><div>使用YAML实现多环境配置要简单的多，只需要一个文件即可，application.yml</div><div>在文件中使用---来区分多个环境，每个环境都需要配置spring.profile属性，不配置的属于默认环境</div><div><span style="font-weight: bold;">激活profiles</span></div><div>可以在命令行参数、系统参数、application.properties等处进行配置</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>命令行</div><div>java -jar xxx.jar --spring.profiles.active=dev --debug=true</div><div><br/></div><div>application.properties</div><div>spring.profiles.active=dev</div><div><br/></div><div>application.yml</div><div>spring:</div><div>  profiles:</div><div>    active: dev</div><div>---</div><div>spring:</div><div>  <strike>profiles</strike>: dev</div><div>server:</div><div>  port: 8082</div><div>---</div><div>spring:</div><div>  <strike>profiles</strike>: test</div><div>server:</div><div>  port: 8083</div></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>spring:</div><div>  profiles:</div><div>    active: test</div><div>---</div><div>spring:</div><div>  config:</div><div>    activate:</div><div>      on-profile: dev</div><div>server:</div><div>  port: 8082</div><div>---</div><div>spring:</div><div>  config:</div><div>    activate:</div><div>      on-profile: test</div><div>server:</div><div>  port: 8083</div></div><div><br/></div><hr/><div>对于maven</div><div>maven的profile用法有许多种，但基本原理就是根据激活环境的不同，自定义字段被赋予不同的值。</div><div>项目结构</div><div><img src="class10_files/Image.png" type="image/png" data-filename="Image.png"/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>&lt;build&gt;</div><div>    &lt;plugins&gt;</div><div>        &lt;plugin&gt;</div><div>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div>            &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</div><div>        &lt;/plugin&gt;</div><div>    &lt;/plugins&gt;</div><div>    &lt;resources&gt;</div><div>        &lt;resource&gt;</div><div>            &lt;directory&gt;src/main/resources/&lt;/directory&gt;</div><div>            &lt;!--打包时先排除掉三个文件夹--&gt;</div><div>            &lt;excludes&gt;</div><div>                &lt;exclude&gt;dev&lt;/exclude&gt;</div><div>                &lt;exclude&gt;prod&lt;/exclude&gt;</div><div>                &lt;exclude&gt;test&lt;/exclude&gt;</div><div>            &lt;/excludes&gt;</div><div>            &lt;includes&gt;</div><div>                &lt;!--如果有其他定义通用文件，需要包含进来--&gt;</div><div>                &lt;include&gt;static/*&lt;/include&gt;</div><div>                &lt;include&gt;templates/*&lt;/include&gt;</div><div>            &lt;/includes&gt;</div><div>        &lt;/resource&gt;</div><div>        &lt;resource&gt;</div><div>            &lt;!--这里是关键！ 根据不同的环境，把对应文件夹里的配置文件打包--&gt;</div><div>            <b>&lt;directory&gt;src/main/resources/<span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">${profiles.active}</span>&lt;/directory&gt;</b></div><div>        &lt;/resource&gt;</div><div>    &lt;/resources&gt;</div><div>&lt;/build&gt;</div><div>&lt;profiles&gt;</div><div>    &lt;profile&gt;</div><div>        &lt;!--不同环境Profile的唯一id--&gt;</div><div>        &lt;id&gt;dev&lt;/id&gt;</div><div>        &lt;properties&gt;</div><div>            <b>&lt;!--profiles.active是自定义的字段，自定义字段可以有多个--&gt;</b></div><div><b>            <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">&lt;profiles.active&gt;dev&lt;/profiles.active&gt;</span></b></div><div>        &lt;/properties&gt;</div><div>    &lt;/profile&gt;</div><div>    &lt;profile&gt;</div><div>        &lt;id&gt;prod&lt;/id&gt;</div><div>        &lt;properties&gt;</div><div>            &lt;profiles.active&gt;prod&lt;/profiles.active&gt;</div><div>        &lt;/properties&gt;</div><div>        <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">&lt;!--activation用来指定激活方式，可以根据jdk环境，环境变量，文件的存在或缺失--&gt;</span></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">        <b>&lt;activation&gt;</b></span></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><b>            &lt;activeByDefault&gt;true&lt;/activeByDefault&gt;</b></span></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><b>        &lt;/activation&gt;</b></span></div><div>    &lt;/profile&gt;</div><div>    &lt;profile&gt;</div><div>        &lt;id&gt;test&lt;/id&gt;</div><div>        &lt;properties&gt;</div><div>            &lt;profiles.active&gt;test&lt;/profiles.active&gt;</div><div>        &lt;/properties&gt;</div><div>    &lt;/profile&gt;</div><div>&lt;/profiles&gt;</div></div><div><span style="font-weight: bold;">激活方式</span></div><div>1.通过maven命令参数</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>mvn clean package -Ptest</div></div><div>2.通过pom文件里的activation属性</div><div>3.settings.xml中使用activeProfiles指定（了解即可，不推荐）</div><div>mave目录下的settings.xml也可以添加下面的代码来指定激活哪个profile。</div><div>&lt;activeProfiles&gt;  </div><div>     &lt;activeProfile&gt;profileTest1&lt;/activeProfile&gt;  </div><div>&lt;/activeProfiles&gt;</div><div><br/></div><hr/><div>maven与spring结合使用</div><div><img src="class10_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><b style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">mvn package -Pdev</b></div><div><br/></div><div>spring:</div><div>  profiles:</div><div>    active: <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><b>&quot;@profiles.active@&quot;</b></span></div><div><br/></div><div>&lt;profiles&gt;</div><div>    &lt;profile&gt;</div><div>        &lt;!--不同环境Profile的唯一id--&gt;</div><div>        &lt;id&gt;dev&lt;/id&gt;</div><div>        <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">&lt;properties&gt;</span></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">            &lt;!--profiles.active是自定义的字段，自定义字段可以有多个--&gt;</span></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">            <b>&lt;profiles.active&gt;dev&lt;/profiles.active&gt;</b></span></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">        &lt;/properties&gt;</span></div><div>    &lt;/profile&gt;</div><div>    &lt;profile&gt;</div><div>        &lt;id&gt;prod&lt;/id&gt;</div><div>        &lt;properties&gt;</div><div>            &lt;profiles.active&gt;prod&lt;/profiles.active&gt;</div><div>        &lt;/properties&gt;</div><div>        &lt;!--activation用来指定激活方式，可以根据jdk环境，环境变量，文件的存在或缺失--&gt;</div><div>        &lt;activation&gt;</div><div>            &lt;activeByDefault&gt;true&lt;/activeByDefault&gt;</div><div>        &lt;/activation&gt;</div><div>    &lt;/profile&gt;</div><div>    &lt;profile&gt;</div><div>        &lt;id&gt;test&lt;/id&gt;</div><div>        &lt;properties&gt;</div><div>            &lt;profiles.active&gt;test&lt;/profiles.active&gt;</div><div>        &lt;/properties&gt;</div><div>    &lt;/profile&gt;</div><div>&lt;/profiles&gt;</div></div><hr/><div><br/></div><div>profile机制</div><div>spring：只是用环境变量来控制加载</div><div>maven</div><div>后面发展到配置中心</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">spring两种方式</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">1.在application.yml中写</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">spring.profiles.active=dev</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">2.java -jar xx.jar --spring.profiles.active=dev --debug=true</span></div><div><font face="Monaco">maven</font></div><div><font face="Monaco">在pom.xml文件中定义，命令行执行</font></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">mvn clean package -Prelease,test</span></div></div><div><br/></div><div>sharding-jdbc</div><div>sharding-proxy（类似mycat）</div><div>sharding-scaling（数据迁移）</div><div>分库分表，读写分离，加密解密，分布式事务，数据迁移和扩容</div><div>启动后虚拟成数据库，把源数据库所有表的元数据都捞出来，等调用时再真正访问数据库。</div><div><br/></div><div>自动化配置原理</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>@EnableAutoConfiguration</div><div><br/></div><div><br/></div></div><div>@SpringBootApplication</div><div><br/></div><div>条件化<span style="font-size: unset; color: unset; font-family: unset;">自动配置</span></div><div>@ConditionalOnBean</div><div>@ConditionalOnClass</div><div>@ConditionalOnMissingBean</div><div>@ConditionalOnProperty</div><div>@ConditionalOnResource</div><div>@ConditionalOnSingleCandidate</div><div>@ConditionalOnWebApplication</div><div>运行时灵活组装，避免冲突</div><div><br/></div><div><span style="font-weight: bold;">3.Spring Boot starter详解*</span></div><div>使用时，分2步：</div><ol><li><div>在pom文件中引入starter依赖</div></li><li><div>在配置文件中配置所需属性</div></li></ol><div>实现主要组成：</div><ul><li><div>SpringBootConfiguration.java</div></li><ul><li><div>自动配置类</div></li></ul><li><div>spring.factories</div></li><li><div>spring.provides</div></li><li><div>metadata.json</div></li><ul><li><div>相当于XML时代的xsd文件，但这个可以有默认值</div></li></ul></ul><div><img src="class10_files/Image [2].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>selector先把所有被@Configuration的类捞出来，按照@AutoConfigureBefore等注解排序。</div><div><br/></div><div>druid的starter与shardingsphere的starter冲突，各自new出一个dataSource，Spring在启动项目时，不知道应该用哪个，就会报错。解决方法：引入shardingsphere的starter，只引入druid的依赖，而不引druid的starter。</div><div><br/></div><div><span style="font-weight: bold;">4.JDBC与数据库连接池*</span></div><div>数据库是需要保存状态的</div><div><br/></div><div>JDBC定义了数据库交互接口：</div><ul><li><div>DriverManager（把实现隐藏到驱动里了）</div></li><li><div>Connection</div></li><li><div>Statement</div></li><li><div>ResultSet</div></li><li><div>DataSource--Pool（后来增加的）</div></li></ul><div>JDBC接口不关心具体实现，可以不断的包装</div><div>Java操作数据库的各种类库，都可以看做是在JDBC上做的增强实现。</div><div><br/></div><div>MySQL驱动JDBC接口 -- Connection</div><div>从连接池获取 -- PooledConnection</div><div>加上XA事务 -- XAConnection</div><div><br/></div><div>MyCat相当于Shardingsphere-proxy，代理</div><div><br/></div><div>数据库连接池：</div><ul><li><div>C3P0</div></li><li><div>DBCP - 基于Apache CommonPool</div></li><li><div>Druid（记录SQL及执行时间的监控）</div></li><ul><li><div>但现在通常做法，是把监控和业务分离开，可以使用第三方的监控软件、APM<span style="font-size: unset; color: unset; font-family: unset;">实现</span></div></li></ul><li><div>Hikari</div></li><ul><li><div>日语 - 光</div></li></ul></ul><div>以下，性能意义不大：</div><ul><li><div>连接池</div></li><ul><li><div>创建连接时比较耗时</div></li></ul><li><div>字节码工具</div></li><ul><li><div>创建类本身时比较耗时</div></li></ul><li><div>json序列化</div></li><ul><li><div>很快</div></li></ul></ul><div>即使在比较耗时的方面差10倍，但是占比不大，可能只是执行一次后，再也不会发生比较耗时的操作了，而是性能差别不大的调用。</div><div>性能优化的方向，先从优化效率高的角度开始。</div><div><br/></div><div><br/></div><div>明白了原理，就可以在Connection外面封装一层实现记录SQL、执行时间等功能。</div><div>或者使用SpringAOP实现，或者使用字节码增强工具实现。</div><div><br/></div><div>fastjson最大的问题是对<span style="font-size: unset; color: unset; font-family: unset;">标准的兼容性不好</span></div><div>比如错的json也能正常转换，几种不同的json转换工具转换后的结果不一致。5000+测试用例有很多不标准的示例。</div><div><br/></div><div><span style="font-weight: bold;">5.ORM-Hibernamt/MyBatis*</span></div><div><br/></div><div>Hibernate</div><div>ORM（Object-Relational Mapping）表示对象关系映射。</div><div>开源对象关系映射框架，对JDBC进行了非常轻量级的对象封装，将POJO与数据库表简历映射关系，是一个全自动的ORM框架。</div><div>自动生成SQL语句，自动执行，使得Java程序员可以使用面向对象的思维来操纵数据库。</div><div>需要定义实体类（E）和hbm（T）映射关系文件（IDE一般有工具生成）</div><div>3种方式操作数据库：</div><ul><li><div>HQL：面向对象的写法，直接使用pojo对象及属性</div></li><li><div>Criteria（拼接SQL，链式编程）</div></li><li><div>Native SQL</div></li></ul><div>关联查询功能关闭，防止把所有有关联的表都从数据库中捞出来。</div><div>运行时如果没有表，可以创建表。</div><div>也可以作为JPA适配实现，使用JPA接口操作。</div><div>实体类+注解+数据源（库里空的）</div><div>读多写少时开启缓存很有用。</div><div>在Zookeeper Client中增加Guava缓存，内容没变时，不用去zk Server频繁拿数据。</div><div><br/></div><div>MyBatis</div><div>优秀的持久层框架</div><div>支持定制SQL、存储过程及高级映射。</div><div>避免了几乎所有的JDBC代码和手动设置参数以及获取结果集。</div><div>使用简单的XML或注解来配置和映射原生信息，将接口和Java的POJOs（Plain Old Java Objects，普通Java对象）映射成数据库中的记录。</div><div>半自动化ORM</div><ol><li><div>需要使用映射文件mapper.xml定义map规则和SQL</div></li><li><div>需要定义mapper/DAO层接口，基于xml规则，操作数据库</div></li></ol><div>一个经验是：继承生成的mapper，而不是覆盖掉。（这样做避免自动生成的修改还需要调整自定义SQL）</div><div>也可以直接在mapper上用注解方式配置SQL。</div><div><br/></div><div>对比</div><div><table style="border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 130px;"></col><col style="width: 130px;"></col><col style="width: 130px;"></col></colgroup><tbody><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div><br/></div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>MyBatis</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>Hibernate</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>优点</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>原生SQL（XML语法），直观，对DBA友好</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>简单场景不用谢SQL（HQL、Cretiria、SQL）</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>缺点</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>繁琐，但是可以使用MyBatis-generator、MyBatis-Plus之类的插件</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>对DBA不友好</div></td></tr></tbody></table><div>功能上，是图灵完备的。</div><div>大公司（流程规范的，对性能有严格要求的）用MyBatis原因：</div><ol><li><div>MyBatis对DBA友好，SQL可控（在开发测试阶段，把所有的SQL捞出来，进行事先的把控）</div></li><ol><li><div>而Hibernate只有执行后才能生成SQL</div></li></ol><li><div>便于SQL优化</div></li></ol><div>也可以使用Hibernate或JPA，前提条件是，尽量把SQL写简单些，比如单表查询等。</div><div><br/></div></div><div><span style="font-weight: bold;">6.Spring集成ORM/JPA*</span></div><div><br/></div><div>JPA，Java Persistence API，即Java持久化API，是一套基于ORM的规范，内部是由一系列的接口和抽象类构成。</div><div>JPA通过JDK5.0注解描述对象-关系表映射关系，并将运行期的实体对象持久化到数据库中。</div><div>核心 EntityManager</div><ul><li><div>Hibernate</div></li><li><div>OpenJPA</div></li><li><div>Toplink</div></li><li><div>其他</div></li></ul><div>Spring JDBC 封装JDBC，用来支持Spring的JDBCTemplate，也可以用来支持Hibernate和MyBatis</div><div>Spring ORM 封装JPA，核心用来支持Hibernate的JPA实现</div><div>Spring Data 使用类似的JPA方式，统一了</div><div><br/></div><div>Spring事务管理</div><div>隔离级别 IsolationLevel</div><div>传播行为 PropagationBehavior</div><div><br/></div><div>必须保证对象实例是Spring生成或管理的，否则即使加上注解也不会起作用。</div><div>声明式事务</div><div>@Transactional(propagation = Propagation.REQUIRED)</div><div>@Transactional(isolation = Isolation.READ_UNCOMMITTED)</div><div>读取未提交数据（会出现脏读，不可重复读）基本不使用</div><div>@Transactional(readOnly = true)</div><div>只读事务</div><div>@Transactional(timeout = 30)</div><div>回滚（单元测试时）</div><div>指定单一异常类</div><div>@Transactional(rollbackFor = RuntimeException.class)</div><div>指定多个异常类</div><div>@Transactional(rollbackFor = {RuntimeException.class, Exception.class})</div><div>设计原则：</div><div>Service层不要嵌套</div><div>1.Service层调用DAO层（因为DAO层没有事务）</div><div>2.把需要调用的代码抽离到biz层，在biz层聚合</div><div>计算机中问题，基本都可以通过增加一个中间层来解决。</div><div><br/></div><div>演示项目nicefish-backend</div><div><a href="https://gitee.com/nicefish/nicefish-backend">https://gitee.com/nicefish/nicefish-backend</a></div><div>mvn spring-boot:run</div><div>mvn package + java -jar xxx.jar</div><div><br/></div><div><img src="class10_files/Image [3].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>演示项目shardingsphere-example</div><div>标准的JPA项目结构</div><div><img src="class10_files/Image [4].png" type="image/png" data-filename="Image.png"/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>&lt;bean id=&quot;entityManagerFactory&quot; class=&quot;org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean&quot;&gt;</div><div>    &lt;property name=&quot;dataSource&quot; ref=&quot;shardingDataSource&quot; /&gt;</div><div>    &lt;property name=&quot;jpaVendorAdapter&quot;&gt;</div><div>        &lt;bean class=&quot;org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter&quot; p:database=&quot;MYSQL&quot; /&gt;</div><div>    &lt;/property&gt;</div><div>    &lt;property name=&quot;packagesToScan&quot; value=&quot;org.apache.shardingsphere.example.core.jpa.entity&quot; /&gt;</div><div>    &lt;property name=&quot;jpaProperties&quot;&gt;</div><div>        &lt;props&gt;</div><div>            &lt;prop key=&quot;hibernate.dialect&quot;&gt;org.hibernate.dialect.MySQLDialect&lt;/prop&gt;</div><div>            &lt;prop key=&quot;hibernate.hbm2ddl.auto&quot;&gt;create-drop&lt;/prop&gt;</div><div>            &lt;prop key=&quot;hibernate.show_sql&quot;&gt;false&lt;/prop&gt;</div><div>        &lt;/props&gt;</div><div>    &lt;/property&gt;</div><div>&lt;/bean&gt;</div></div><div><br/></div><div><br/></div><div>7.Spring Boot集成ORM/JPA</div><div><br/></div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>spring.jpa.properties.hibernate.hbm2ddl.auto=create-drop</div><div>spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL5Dialect</div><div>spring.jpa.properties.hibernate.show_sql=false</div></div><br/><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">Spring/Spring Boot使用ROM经验</span></div><ol><li><div><font color="#333333" face="Monaco"><span style="font-size: 12px;">本地事务</span></font></div></li><li><div><font color="#333333" face="Monaco"><span style="font-size: 12px;">多数据源（配置、静态指定、动态切换）</span></font></div></li><li><div><font color="#333333" face="Monaco"><span style="font-size: 12px;">数据库连接池配置（大小、重连、超时）</span></font></div></li><ol><li><div><font color="#333333" face="Monaco"><span style="font-size: 12px;">不要太大，否则性能会下降，一般配几十个即可</span></font></div></li><li><div><font color="#333333" face="Monaco"><span style="font-size: 12px;">一定要配置心跳和重连、超时，应用不用重启</span></font></div></li></ol><li><div><font color="#333333" face="Monaco"><span style="font-size: 12px;">ORM内的复杂SQL，级联查询</span></font></div></li><li><div><font color="#333333" face="Monaco"><span style="font-size: 12px;">ORM辅助工具和插件</span></font></div></li><ol><li><div><font color="#333333" face="Monaco"><span style="font-size: 12px;">优化SQL最多的点：分页查询时，查询总数的select count(id) from 主表，而不是直接在复杂SQL上包一层</span></font></div></li></ol></ol><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;"><br/></span></div></div></span>
</div></body></html> 