<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/602326 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="7823"/>

<div>
<span><div><div><div><div>20201121 第12课</div><hr/><div>开源群技术大拿开展前沿的技术讲座！</div></div><hr/><div><br/></div><div>1.再聊聊性能优化</div><div><br/></div><div>除了性能需要考虑，还有以下方面需要考虑：（虽然不提供功能，但可以保证系统稳定的工作，无需人工过多干预）</div><ul><li><div>数据一致性</div></li><li><div>高可用：系统能够一定程度的容灾</div></li><li><div>可维护性：代码写的看不懂，不便于维护，不便于扩展</div></li></ul><div><br/></div><div>性能衡量指标：</div><ul><li><div>吞吐</div></li><li><div>延迟</div></li><li><div>容量</div></li></ul><div>没有量化就没有改进</div><ul><li><div>监控与度量指标，指导我们怎么去入手</div></li><li><div>硬件、网络的纯技术指标</div></li><li><div>从用户/业务的角度定义指标，全回路日志采集后分析</div></li><li><div>偏离正常性能的事件，找到根因</div></li><li><div>性能在不同场景、不同条件下， 表面是系统崩了，但根因可能完全不一样</div></li></ul><div>80/20原则</div><ul><li><div>先优化性能瓶颈问题，指导我们如何去优化</div></li><li><div>优化工作的基础</div></li><li><div>抓大放小</div></li><li><div>一般情况下</div></li><ul><li><div>业务系统，运行很多年，性能一般出在SQL上</div></li></ul></ul><div>过早的优化是万恶之源</div><ul><li><div>指导我们如何去优化</div></li><li><div>按照对需求的估计，设计一套刚好满足性能的</div></li><li><div>没有带来直接收益的过早优化意义不大</div></li></ul><div>脱离场景谈性能都是耍流氓</div><ul><li><div>指导我们对性能要求要符合实际</div></li></ul><div>性能是一个综合性的问题</div><div><br/></div><div>业务系统分类</div><ul><li><div>计算密集型</div></li><ul><li><div>科学计算：天气、天文等</div></li></ul><li><div>数据密集型</div></li><ul><li><div>后台管理等</div></li></ul></ul><div>业务处理本身无状态，数据状态最终要保存到数据库</div><ul><li><div>因为无状态，可以加机器</div></li><li><div>但数据库一般只有一个，需要保证数据一致性</div></li></ul><div>一般来说，DB/SQL操作的消耗在一次处理中占比最大</div><ul><li><div>单库精准操作</div></li><li><div>但是次数过多也会慢</div></li></ul><div>业务系统发展的不同阶段和时期，性能瓶颈要点不同，类似木桶装水</div><div>案例：</div><div>ERP软件改成SaaS软件</div><div>CS软件，开发维护成本很高</div><ul><li><div>操作系统版本不同</div></li><li><div>杀毒软件，破坏文件，软件直接崩溃</div></li><li><div>店主IT知识不足</div></li><li><div>硬件配置不行，电脑卡</div></li></ul><div>100多个模块，需要符合国家标准</div><div>20个人，半年时间开发</div><div>约小半年推广和测试，系统是否稳定，用户体验如何</div><div>单机版系统，性能、稳定性、用户体验是没有概念的</div><ul><li><div>每天不超过1000单，最常见100-200单</div></li><ul><li><div>一年特别忙也就7.3w-36.5w</div></li></ul><li><div>库存不超过1000，700-800</div></li><ul><li><div>一年29.2w-36.5w</div></li></ul><li><div>用十年，单表也就几十万</div></li><li><div>性能要求不高时</div></li><ul><li><div>表结构可以随意设计，如一张表100多个字段</div></li><li><div>SQL可以随便写，如依次查询连10张表</div></li></ul></ul><div>改成SaaS软件，给1w用户使用</div><ul><li><div>订单表数据量变为原来的1w倍，每天100w-200w</div></li><li><div>数据库需要重新设计</div></li><ul><li><div>拆分为小表</div></li><li><div>核心字段与非核心字段拆开</div></li><li><div>重构部分会着重介绍</div></li></ul></ul><div>在改造软件，首要任务：</div><ul><li><div>说服有决策权限的人，让他们对性能、稳定性认识到难度，远没有想象的简单</div></li></ul><div><br/></div><div><span style="font-weight: bold;">2.关系数据库MySQL*</span></div><div><br/></div><div>关系数据库</div><div>埃德加·科德（Edgar Frank Codd）1970年提出关系模型</div><div>《A Relational Model of Data for Large Shared Data Banks》</div><div>元祖tuple，可以看成向量</div><div>E-R图（Entity-Relation）</div><div>投影projection：查单表部分字段，多维向量投影，舍弃一部分字段</div><div>数据库所有操作，都可以通过关系代数，转换为关系的操作</div><div><br/></div><hr/><div><br/></div><div><a href="https://app.yinxiang.com/shard/s52/nl/11173257/a6ba7c5a-3db5-4a07-9a52-07234ea65db4">XXX as a Service</a></div><div>SaaS    软件即服务，功能软件从单机版变成Web多租户</div><div>PaaS    平台即服务</div><ul><li><div>google的GAE，新浪的SAE，基础设施都是共享的，可以自行部署应用</div></li></ul><div>IaaS     基础设施即服务，通过云的方式共享</div><ul><li><div>公有云，私有云，OpenStack，ECS</div></li></ul><div><br/></div><div>FaaS    Function as a Service，Serverless，函数即服务，headless，以后的趋势</div><div>DaaS    数据即服务，数据隐私问题，还不是很明朗</div><div><br/></div><hr/><div><br/></div><div>SQL是图灵完备的</div><div>数据库设计范式</div><div>第一范式（1NF）：关系R属于第一范式，当且仅当R中的每一个属性A的值只包含原子项</div><div>第二范式（2NF）：在满足1NF的基础上，消除非主属性对码的<span style="font-weight: bold;">部分函数依赖</span></div><div>第三范式（3NF）：在满足2NF的基础上，消除非主属性对码的<span style="font-weight: bold;">传递函数依赖</span></div><div>BC范式（BCNF）：在满足3NF的基础上，消除主属性对码的部分和传递函数依赖</div><div>第四范式（4NF）：消除非平凡的多值依赖</div><div>第五范式（5NF）：消除一些不合适的连接依赖</div><div>    也成为完美范式，不现实</div><div><br/></div><div>1NF：消除重复数据，即每一列都是不可再分的基本数据项，每个列都是原子的</div><div>如果下表中，存在【系名-系主任】这么一个字段，就不符合1NF，写入不好写，查询也不好查</div><div><img src="class12_files/Image.png" type="image/png" data-filename="Image.png"/></div><div><span style="font-size: unset; color: unset; font-family: unset;">2NF：消除部分依赖，表中没有列只与主键的部分相关，即每一行都被主键唯一标识；每个列都有主键。</span></div><div><img src="class12_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div>3NF：消除传递依赖，消除表中列不依赖主键，而是依赖表中的非主键列的情况，即没有列是与主键不相关的。</div><div>从表只引用主表的主键，即表中每列都和主键相关。</div><div><img src="class12_files/Image [2].png" type="image/png" data-filename="Image.png"/></div><div>BCNF：Boyce-Codd Normal Form（巴斯-科德范式）</div><div>3NF基础上消除主属性对于码的部分与传递函数依赖。</div><div><img src="class12_files/Image [3].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>订单</div><div>    买卖双方</div><div>    商品基本信息，详情信息</div><div>    优惠券，红包，打折，满减满赠</div><div>    配送信息（收件地址，姓名，电话），物流信息（公司）</div><div>    保险，运费险</div><div>拆分</div><div>主表：</div><div>    时间</div><div>    交易双方id</div><div>    交易商品id</div><div>    订单价格</div><div>    商品快照</div><div>    商品数量</div><div><br/></div><div>学校</div><div>班级</div><div>学生</div><div><br/></div><div>范式不是约定创建表时的铁律</div><div>是最基本的指导思想，是要打破的。</div><div>所以，一定程度要有一定的冗余</div><div>如订单价格可以通过商品单价*数量相加获得，但可以作为一个字段冗余，一是方便查询，二是可以作为检查项，如果计算出来的与存储的不一致，就知道这个订单肯定是有问题了。</div><div><br/></div><hr/><div>一范式主要用于实体表之中</div><div>二范式主要是在关系表之中， 比如学分表【学生-课程】，如果中间有冗余，比如学号、姓名，课程id，课程名称、教室。 那么不符合二范式。</div><div>三范式控制实体表和关系表，需要有主键唯一标识数据。</div><div><br/></div><div>把没有关系的属性拆开，把没有关系的实体拆开</div><hr/><div><br/></div><div>常见关系数据库</div><div>开源：MySQL、PostgreSQL</div><div>商业：Oracle，DB2，SQL Server</div><div><br/></div><div>内存数据库：Redis？，VoltDB</div><div>图数据库：Neo4j，Nebula</div><div>时序数据库：InfluxDB、openTSDB</div><div>其他关系数据库：Access、Sqlite、H2、Derby、Sybase、Infomix等</div><div>NoSQL数据库：MongoDB、Hbase、Cassandra、CouchDB</div><div>NewSQL/分布式数据库：TiDB、CockroachDB、NuoDB、OpenGauss、OB、TDSQL</div><div><br/></div><hr/><div>Derby由于比较小，2M左右，JDK默认收录了，后来又删除了，对事务支持很完美。</div><div>如果MySQL看做是Tomcat，Derby可以看做是Jetty。</div><div>H2，内存数据库，可以用来执行单元测试。</div><div>Redis就是缓存，没有事务，没有一致性的保障。</div><div>VoltDB，一枝独秀，一致性，数据可靠，大部分操作在内存。</div><div>图数据库（图论），大部分国内的人在搞。用来存储，如Facebook或微博里10w用户，之间是不是好友，有没有关注之类的数据。</div><div>时序数据库，用来存储监控打点的数据。离散的数据，按时间周期来获取，获取一个时间窗口内（半个小时内）的数据，平均值等。</div><div>NoSQL，单机数据库瓶颈时，放弃掉关系数据库中某个点，在其他点获得很大提升（牺牲掉一些数据库的特性，实时严格一致性，不提供严格表数据结构，不定义schema，动态加减列都可以）。像日志一些不重要的数据丢失一部分不重要。</div><div>TiDB，CockroachDB，结构很像，前者国内的，后者国外的。</div><div><br/></div><hr/><div><br/></div><div>SQL语言</div><div>SQL语言（Structured Query Language，结构化查询语言）</div><div>在1970年代初，由IBM公司San Jose,California研究实验室的埃德加·科德发表将资料组成表格的应用原则（Codd's Relational Algebra）。1974年，同一实验室的D.D.Chamberlin和R.F. Boyce对Codd's Relational Algebra在研制关系数据库管理系统System R中，研制出一套规范语言-SEQUEL（Structured English Query Language），并在1976年11月的IBM Journal of R&amp;D上公布新版本的SQL（叫SEQUEL/2）。1980年改名为SQL。</div><div><br/></div><div>SQL包含六个部分</div><ol><li><div>DQL：数据查询语言，Data Query Language，数据检索语句，SELECT/WHERE/ORDER BY/GROUP BY/HAVING</div></li><li><div>DML：数据操作语言，Data Manipulation Language，INSERT/UPDATE/DELETE</div></li><li><div>TCL：事务控制语言，确保被DML语句影响的表的所有行为及时得以更新。COMMIT/SAVEPOINT/ROLLBACK</div></li><li><div>DCL：数据控制语言，通过GRANT/REVOKE实现权限控制，确定单个用户和用户组对数据库对象的访问。某些RDBMS可用GRANT/REVOKE控制对表单列的访问。</div></li><li><div>DDL：数据定义语言，在数据库中创建新表或修改、删除表，为表加索引。CREATE/ALTER/DROP</div></li><li><div>CCL：指针控制语言，用于对一个或多个表单独行的操作。DECLARE CURSOR/FETCH INTO/UPDATE WHERE CURRENT</div></li></ol><div>不建议用游标。</div><div><br/></div><div>现在常用的标准</div><div>1992年，ANSI X3.135-1992，ISO/IEC 9075:1992，SQL-92（SQL2）</div><div>1999年，ISO/IEC 9075:1999，SQL:1999（SQL3）</div><div><br/></div><div>手写SQL Parser，纯体力活。</div><div>SQL</div><ol><li><div>手写：druid，mycat</div></li><li><div>antlr4：shardingsphere</div></li><li><div>yacc（默认C版本）：mysql，tidb，Cockroachdb</div></li></ol><div><br/></div><div>挑战作业：</div><div>select id,name from users where id&gt;100 order by id desc limit 10;</div><div><br/></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">做作业时思考：为什么那么设计，好不好，能不能改进？</span></div><div><br/></div><div>MySQL数据库</div><div>1995年，瑞典的MySQL AB创立</div><div>2008年1月16日MySQL被Sun Microsystems收购</div><div>2009年4月20日，Oracle收购Sun Microsystems公司</div><div>分离成两个版本：MariaDB和MySQL，以老板女儿名字命名</div><div><br/></div><div>MySQL版本</div><ol><li><div>4.0支持InnoDB，支持事务</div></li><li><div>5.0,2003年</div></li><li><div>5.6，历史使用最多的版本</div></li><li><div>5.7，近期使用最多的版本</div></li><li><div>8.0，最新和功能完善的版本</div></li></ol><div>数据库圈里的大牛，DBA，认为类型互相转换不规范（数字、字符可以互相转换）。</div><div>国内，保守，一般选择5.7版本。</div><div>工作中需要钻研5.7，个人兴趣可以学习8.0。</div><div><br/></div><div>PostgreSQL</div><div>    对商业友好，模型规范</div><div>    好多兼容Oracle，就是用PG改的拿来卖</div><div><br/></div><div>5.6/5.7差异，5.7支持：</div><ol><li><div>多主</div></li><li><div>MGR高可用（分组复制）</div></li><li><div>分区表（类似于分表）</div></li><li><div>json</div></li><li><div>大大提升性能</div></li><li><div>修复XA事务（到Oracle手里才修复）</div></li></ol><div>5.7/8.0差异</div><ol><li><div>通用表达式CTE（递归方式读取树结构，SQLServer更强大-pivot交叉表）</div></li><li><div>窗口函数（每门课的前3名）</div></li><li><div>持久化参数，set persist</div></li><li><div>自增列持久化（auto_increment，8.0之前没有持久化，删除一条数据后重启id值有问题）</div></li><li><div>默认编码utf8mb4（这是真UTF-8，历史遗留问题）</div></li><li><div>DDL原子性</div></li><li><div>JSON增强</div></li><li><div><span style="font-weight: bold;">不再对group by进行隐式排序，坑</span>（类似JDK8HashMap）</div></li><ol><li><div>5.6-5.7会自动排序</div></li><li><div>8.0不自动排序，与其他正常数据库保持一致</div></li></ol></ol><div><br/></div><div><span style="font-weight: bold;">3.深入数据库原理*</span></div><div><br/></div><div>MySQL架构图</div><div><img src="class12_files/Image [4].png" type="image/png" data-filename="Image.png"/></div><div>InnoDB，事务</div><div>Archive，归档，不怎么查，压缩</div><div>Memory，内存</div><div><span style="font-size: unset; color: unset; font-family: unset;">Redo，Undo，log保证事务</span></div><div>binlog主从一致</div><div><br/></div><div>MySQL存储</div><div>独占模式</div><div>1）、日志组文件：ib_logfile0和ib_logfile1，默认均为5M</div><div>2）、表结构文件：*.frm</div><div>3）、独占表空间文件：*.ibd</div><div>4）、字符集和排序规则文件：db.opt</div><div>5）、binlog二进制日志文件：记录主数据库服务器的DDL和DML操作</div><div>6）、二进制日志索引文件：master-bin.index</div><div>共享模式 innodb_file_per_table=1</div><div>1）、数据都在ibdata1</div><div><br/></div><div>show databases;</div><div>information_schema存储元数据，在data文件夹里没有，其他都是一一对应的。</div><div>MySQL，启动时，是一个MySQL Server实例。</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>-- 两个命令是等价的</div><div>create database k1;</div><div>create schema k1;</div><div><br/></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">show databases; -- 看到的才是数据库</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;"><br/></span></div><div>use information_schema;</div><div>select table_name from tables; -- 查询所有表名</div></div><div><br/></div><div>db.opt</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>default-character-set=utf8</div><div>default-collation=utf8_general_ci</div><div><br/></div></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>use mysql;</div><div>mysql&gt; <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">desc servers;</span></div><div>mysql&gt; <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">show columns from servers;</span></div><div>+-------------+----------+------+-----+---------+-------+</div><div>| Field       | Type     | Null | Key | Default | Extra |</div><div>+-------------+----------+------+-----+---------+-------+</div><div>| Server_name | char(64) | NO   | PRI |         |       |</div><div>| Host        | char(64) | NO   |     |         |       |</div><div>| Db          | char(64) | NO   |     |         |       |</div><div>| Username    | char(64) | NO   |     |         |       |</div><div>| Password    | char(64) | NO   |     |         |       |</div><div>| Port        | int(4)   | NO   |     | 0       |       |</div><div>| Socket      | char(64) | NO   |     |         |       |</div><div>| Wrapper     | char(64) | NO   |     |         |       |</div><div>| Owner       | char(64) | NO   |     |         |       |</div><div>+-------------+----------+------+-----+---------+-------+</div><div>9 rows in set (0.00 sec)</div><div><br/></div><div><br/></div><div>mysql&gt; show create table servers;</div><div>+---------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</div><div>| Table   | Create Table                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |</div><div>+---------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</div><div>| servers | CREATE TABLE `servers` (</div><div>  `Server_name` char(64) NOT NULL DEFAULT '',</div><div>  `Host` char(64) NOT NULL DEFAULT '',</div><div>  `Db` char(64) NOT NULL DEFAULT '',</div><div>  `Username` char(64) NOT NULL DEFAULT '',</div><div>  `Password` char(64) NOT NULL DEFAULT '',</div><div>  `Port` int(4) NOT NULL DEFAULT '0',</div><div>  `Socket` char(64) NOT NULL DEFAULT '',</div><div>  `Wrapper` char(64) NOT NULL DEFAULT '',</div><div>  `Owner` char(64) NOT NULL DEFAULT '',</div><div>  PRIMARY KEY (`Server_name`)</div><div>) ENGINE=InnoDB DEFAULT CHARSET=utf8 STATS_PERSISTENT=0 COMMENT='MySQL Foreign Servers table' |</div><div>+---------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</div><div>1 row in set (0.00 sec)</div><div><br/></div></div><div><br/></div><div>MySQL简化执行流程</div><div><img src="class12_files/Image [5].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><img src="class12_files/Image [6].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>MySQL执行引擎和状态</div><div><img src="class12_files/Image [7].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>对SQL执行顺序</div><ol><li><div>from，以表为操作维度的</div></li><li><div>on</div></li><li><div>join</div></li><li><div>where，把表找到了增加筛选条件</div></li><li><div>group by</div></li><li><div>having+聚合函数</div></li><li><div>select，输出列</div></li><li><div>order by</div></li><li><div>limit</div></li></ol><div>索引原理</div><div>经验规律：查询id=5的数据，id=4/6的数据很可能也会被用</div><div>数据是按页来分块的，当一个数据被用<span style="font-size: unset; color: unset; font-family: unset;">到时，其附近的数据也通常会马上被使</span><span style="font-size: unset; color: unset; font-family: unset;">用。</span></div><div>InnoDB使用B+树实现<span style="font-weight: bold;">聚集索引</span></div><div>默认使用主键，查询速度快。</div><div>每个节点表示多个数据，放在块里</div><div>只有叶子节点上有数据</div><div><br/></div><div>单表2000W数据</div><div>B+树，默认2~3层，超过3层，多一次IO操作</div><div>bigint 8字节，指针6字节</div><div>14字节</div><div>页16k</div><div>16k/14字节=1170</div><div>一页可以放1170个主键</div><div>高度为2的B+树，16个页，1170*16=18720条</div><div>高度为3的B+树，1170*16个页，1170*1170*16=2190w条</div><div><br/></div><div>安装方式</div><div>安装的几种方式，安装文件或命令，docker</div><div>操作工具，mysql-cli或IDE(DataGrip,MySQL-WorkBench,MySQL-Front,Navicat等)</div><div>MySQL库结构，操作语句与命令</div><div><br/></div><div>免安装压缩包方式，可以通过不同的配置文件，启多个实例</div><div><br/></div><div><span style="font-weight: bold;">【坑】</span>在Mac/Linux下，mysql命令如果不指定-h，默认不走TCP，而是走的UNIX socket通信方式</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>mysql -hlocalhost -P3306 -uroot -p</div></div><div>8.0默认密码加密方式改了，如果用5.6/5.7客户端连接8.0，需要修改加密方式。</div><div><br/></div><div><span style="font-weight: bold;">4.MySQL配置优化*</span></div><div><br/></div><div>查看配置参数</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>show variables;</div><div><br/></div><div>D:\develop\mysql-5.7.32-winx64\bin&gt;mysql -uroot -e &quot;show variables&quot; &gt; d:\mysql.txt</div><div><br/></div><div>D:\develop\mysql-5.7.32-winx64\bin&gt;notepad d:\mysql.txt</div></div><div><br/></div><div>my.cnf配置文件</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-weight: bold;">[mysqld]</span></div><div>server</div><div><br/></div><div><span style="font-weight: bold;">[mysql]</span></div><div>client</div></div><div><br/></div><div>参数配置优化</div><div><br/></div><div>1.连接请求的变量</div><ol><li><div><span style="font-weight: bold;">max_connections</span></div></li><ol><li><div>最大连接数，设置太大太小都不行</div></li><li><div>连接的资源对于MySQL Server来说是最最宝贵的</div></li></ol><li><div>back_log</div></li><li><div>wait_timeout和interative_timeout</div></li></ol><div>2.缓冲区变量</div><ol><li><div>key_buffer_size</div></li><li><div><span style="font-weight: bold;">query_cache_size</span></div></li><ol><li><div>查询缓存，简称QC</div></li></ol><li><div>max_connect_errors</div></li><li><div>sort_buffer_size</div></li><li><div><span style="font-weight: bold;">max_allowed_packet=32M</span></div></li><ol><li><div>不建议每次查询数据集过大，达到几M</div></li><li><div>有些计算放在MySQL里</div></li></ol><li><div>join_buffer_size=2M</div></li><li><div>thread_cache_size=300</div></li></ol><div>3.配置Innodb的几个变量</div><ol><li><div><span style="font-weight: bold;">innodb_buffer_pool_size</span></div></li><li><div>innodb_flush_log_at_trx_commit</div></li><li><div><span style="font-weight: bold;">innodb_thread_concurrency=0</span></div></li><li><div><span style="font-weight: bold;">innodb_log_buffer_size</span></div></li><li><div>innodb_log_file_size=50M</div></li><li><div>innodb_log_files_in_group=3</div></li><li><div><span style="font-weight: bold;">read_buffer_size=1M</span></div></li><li><div>read_rnd_buffer_size=16M</div></li><li><div><span style="font-weight: bold;">bulk_insert_buffer_size=64M</span></div></li><li><div>binary log</div></li></ol><div>如果有权限调整参数，可以尝试微调，但不要大动，可能影响系统稳定性。</div><div><br/></div><div>MySQL刚启动和充分预热后，性能差异很大</div><div>MySQL技术内幕</div><div>数据库系统全书</div><div>数据密集型应用系统设计</div><div><br/></div><div><span style="font-weight: bold;">5.数据库设计优化*</span></div><div><br/></div><div>MySQL数据库设计优化-最佳实践</div><div><br/></div><ol><li><div>如何恰当选择引擎？</div></li><ol><li><div>不同场景使用不同的引擎</div></li></ol><li><div>库表如何命名？</div></li><ol><li><div>特别考验技术</div></li><li><div>对于程序运行时无所谓，但是要给人阅读的</div></li><li><div>一定要有意义，表以t_开头</div></li></ol><li><div>如何合理拆分宽表？</div></li><ol><li><div>谁在什么时间购买了什么商品，价格多少，数量多少，其他都可以使用其他表关联即可</div></li><li><div>好处后续《重构》部分会详说</div></li></ol><li><div>如何选择恰当数据类型：明确、尽量小</div></li><ol><li><div>char、varchar的选择</div></li><ol><li><div>明确--&gt;长度固定，定长字段查找时更好找</div></li></ol><li><div>（text/blob/clob）的使用问题？</div></li><ol><li><div>blob/clob使用后，性能下降5-10倍</div></li></ol><li><div>文件、图片是否要存入到数据库？</div></li><ol><li><div>早期，图片作为blob存库，现在不建议</div></li><li><div>设计良好的表一条数据一般不会超过1k，但图片动辄几k，大的上百k，作为一个字段存库时，打破B+树设计良好的现状</div></li><li><div>数据库存储结构化数据，这种半结构化、非结构化数据考虑放分布式文件系统里，如淘宝的TFS，自己搭建NFS，FastDFS，或本地磁盘里</div></li><li><div>数据库里存储路径，或标识符</div></li></ol><li><div>时间日期的存储问题？</div></li><ol><li><div>一定要注意时区问题</div></li><li><div>UTC还是东八区时区</div></li><li><div>推荐存时间戳，System.currentMillis()，便于计算</div></li></ol><li><div>数值的精度问题？</div></li><ol><li><div>交易系统，超出int，float</div></li><li><div>有效数字有限的小数</div></li><li><div>BigInteger，BigDecimal</div></li><li><div>如果太长了，数据库中使用字符串，捞出来时做转化</div></li><li><div>整数、精度拆分2个字段</div></li></ol></ol><li><div>是否使用外键、触发器？</div></li><ol><li><div>绝大部分情况下，不推荐使用外键和触发器</div></li><li><div>业务系统中保证</div></li><li><div>因为触发器引入了一定的不确定性</div></li></ol></ol><div><br/></div><ol><li><div>唯一约束和索引的关系？</div></li><ol><li><div>唯一约束主流数据库会默认创建一个唯一索引，唯一索引也就是一个唯一索引</div></li></ol><li><div>是否可以冗余字段？</div></li><ol><li><div>如果需要，放心大胆的使用冗余字段，只要能提升查询性能</div></li><li><div>适当打破范式，在提升性能时大有用处</div></li></ol><li><div>是否使用游标、变量、视图、自定义函数、存储过程？</div></li><ol><li><div>非常不建议使用</div></li><li><div>业务逻辑在数据库中，很难维护，没法移植</div></li></ol><li><div>自增主键的使用问题？</div></li><ol><li><div>auto_increment（mysql、sqlserver）</div></li><li><div>sequence（oracle全局的）</div></li><li><div>分布式的不建议使用，每个数据库里可能重复</div></li></ol><li><div>能够在线修改表结构（DDL操作）？</div></li><ol><li><div>在线修改表结构，DDL操作，锁表</div></li><li><div>导入导出备份时，会锁表</div></li></ol><li><div>逻辑删除还是物理删除？</div></li><ol><li><div>重要数据，只逻辑删除，增加delete字段</div></li><li><div>如果数据库不需要溯源，可以物理删除</div></li></ol><li><div>要不要加create_time,update_time时间戳？</div></li><ol><li><div>非常建议加时间戳</div></li><li><div>同步数据时，根据更新时间计算，增量数据</div></li></ol><li><div>数据库碎片问题？</div></li><ol><li><div>索引碎片</div></li><li><div>数据库碎片问题，自带命令压缩时锁表</div></li></ol><li><div>如何快速导入导出、备份数据？</div></li><ol><li><div>备份数据是必要的，主从</div></li><li><div>导入，一条一条写，批量写</div></li><li><div>使用数据库原生命令，比脚本快很多</div></li><li><div>可以将索引、外键等删除后，导出，导入后统一增加</div></li></ol></ol><div><br/></div><div>第12节课作业实践</div><div>1、（选做）：基于课程中的设计原则和最佳实践，分析是否可以将自己负责的业务系<span style="font-size: unset; color: unset; font-family: unset;">统进行数据库设计或是数据库服务器方面的优化。</span></div><div>2、（必做）：基于电商交易场景（用户、商品、订单），设计一套简单的表结构，提<span style="font-size: unset; color: unset; font-family: unset;">交DDL的SQL文件到Github（后面2周的作业依然要是用到这个表结构）。</span></div><div>3、（选做）：尽可能多的从“常见关系数据库”中列的清单，安装运行，并使用上一题<span style="font-size: unset; color: unset; font-family: unset;">的SQL测试简单的增删改查。</span></div><div>4、（选做）：基于上一题，尝试对各个数据库测试100万订单数据的增删改查性能。</div><div>5、（选做）：尝试对MySQL不同引擎下测试100万订单数据的增删改查性能。</div><div>6、（选做）：模拟1000万订单数据，测试不同方式下导入导出（数据备份还原）<span style="font-size: unset; color: unset; font-family: unset;">MySQL的速度，包括jdbc程序处理和命令行处理。思考和实践，如何提升处理效率。</span></div><div>7、（选做）：对MySQL配置不同的数据库连接池（DBCP、C3P0、Druid、Hikari），<span style="font-size: unset; color: unset; font-family: unset;">测试增删改查100万次，对比性能，生成报告。</span></div><div><br/></div><div><img src="class12_files/Image [8].png" type="image/png" data-filename="Image.png" width="471"/></div></div><br/></div><div><br/></div></span>
</div></body></html> 